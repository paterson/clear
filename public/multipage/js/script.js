// Generated by CoffeeScript 1.6.3
'use strict';
var App, PAYMILL_PUBLIC_KEY, controller, domain;

domain = 'http://localhost:3000/';

App = angular.module('iframe', []);

PAYMILL_PUBLIC_KEY = '...';

controller = function($scope, $http, $timeout) {
  $scope.cards = {};
  $scope.transactions = {};
  $scope.stores = {};
  $scope.pay = {};
  $scope.tmp = {};
  $scope.cards.list = [];
  $scope.transactions.list = [];
  $scope.permissions = {
    loggedIn: function() {
      return ($scope.token != null) && ($scope.stores.show != null);
    },
    cards: function() {
      return $scope.permissions.loggedIn() && !$scope.permissions.pay();
    },
    pay: function() {
      return $scope.permissions.loggedIn() && ($scope.cards.show != null);
    },
    choice: function() {
      return !$scope.permissions.loggedIn() && !$scope.page;
    },
    login: function() {
      return !$scope.permissions.loggedIn() && $scope.page === 'login';
    },
    card: function() {
      return !$scope.permissions.loggedIn() && $scope.page === 'card';
    },
    join_clear: function() {
      return !$scope.permissions.loggedIn() && ($scope.tmp.card.token != null);
    }
  };
  $scope.set_page = function(page) {
    return $scope.page = page;
  };
  $scope.login = function() {
    return $http.post("" + domain + "users/sign_in.json?email=" + $scope.forms.login.email + "&password=" + $scope.forms.login.password).success(function(data) {
      $scope.error = false;
      $scope.token = data.token;
      $scope.me = data.me;
      return $http.get("" + domain + "cards?token=" + $scope.token).success(function(data) {
        $scope.error = false;
        return $scope.cards.list = data.cards;
      }).error(function() {
        return $scope.error = true;
      });
    }).error(function() {
      return $scope.error = true;
    });
  };
  $scope.logout = function() {
    return $scope.token = null;
  };
  $scope.register = function() {};
  $scope.cards.choose = function(card) {
    return $scope.cards.show = card;
  };
  $scope.cards.update = function() {};
  $scope.get_token_for_tmp_card = function() {};
  $scope.store_tmp_card = function() {};
  $scope.pay.unauthenciated = function() {};
  $scope.pay.authenciated = function() {
    var obj;
    obj = {
      store_id: $scope.cards.show.id
    };
    return $http.get("" + domain + "invoices/create?token=" + $scope.token).success(function(data) {
      $scope.error = false;
      obj = {
        card_id: $scope.cards.show.id,
        invoice_id: data.id
      };
      return $http.get("" + domain + "payments/create?token=" + $scope.token).success(function(data) {}).error(function() {
        return $scope.error = true;
      });
    }).error(function() {
      return $scope.error = true;
    });
  };
  $scope.init = function() {
    var store_id;
    store_id = 1;
    return $http.get("" + domain + "stores/" + store_id).success(function(data) {
      $scope.error = false;
      return $scope.stores.show = data.store;
    }).error(function() {
      return $scope.error = true;
    });
  };
  return $scope.init();
};
